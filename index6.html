<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#f3f4f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MemoryPro | Á∫ØÂáÄÁâà</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --bg-color: #f3f4f6; --card-bg: #ffffff; --text-main: #1f2937; --text-sub: #6b7280; --border: #e5e7eb;
            --shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1); --nav-height: 60px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg-color); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* Header */
        .game-header { background: var(--card-bg); padding: 10px 15px; padding-top: max(10px, env(safe-area-inset-top)); box-shadow: 0 2px 10px rgba(0,0,0,0.05); z-index: 20; }
        .user-status { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .level-badge { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; padding: 4px 12px; border-radius: 15px; font-weight: 800; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(99, 102, 241, 0.3); display: flex; align-items: center; gap: 5px; }
        .streak-badge { color: #f59e0b; font-weight: bold; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
        .xp-container { width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; position: relative; }
        .xp-bar { height: 100%; background: linear-gradient(90deg, #6366f1, #ec4899); width: 0%; transition: width 0.5s ease; }
        .xp-text { font-size: 0.7rem; color: var(--text-sub); margin-top: 2px; display: flex; justify-content: space-between; }

        /* Main Layout */
        .main-content { flex: 1; overflow: hidden; position: relative; display: flex; flex-direction: column; }
        .view-section { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: none; flex-direction: column; padding: 15px; overflow-y: auto; }
        .view-section.active { display: flex; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Flashcard */
        .flashcard-container { flex: 1; perspective: 1500px; width: 100%; margin-bottom: 15px; position: relative; min-height: 300px; display: flex; flex-direction: column; justify-content: center;}
        .flashcard { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); border-radius: 20px; box-shadow: var(--shadow); background: var(--card-bg); }
        .flashcard.flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; background: var(--card-bg); border-radius: 20px; border: 1px solid var(--border); display: flex; flex-direction: column; overflow: hidden; }
        .card-back { transform: rotateY(180deg); background: linear-gradient(160deg, var(--card-bg) 70%, rgba(99, 102, 241, 0.1)); }
        .card-scroll { flex: 1; overflow-y: auto; padding: 25px; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .card-text { font-size: 2rem; font-weight: 700; color: var(--text-main); word-wrap: break-word; }
        .text-long { font-size: 1.2rem; text-align: left; }

        /* Controls */
        .controls-area { margin-top: auto; margin-bottom: 20px; }
        .controls { display: flex; gap: 10px; }
        .btn-action { flex: 1; padding: 15px 5px; border-radius: 16px; border: none; font-size: 0.9rem; font-weight: 700; color: white; cursor: pointer; transition: transform 0.1s; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 4px; }
        .btn-action:active { transform: scale(0.96); }
        .btn-fail { background: var(--danger); } .btn-hard { background: var(--warning); } .btn-pass { background: var(--success); }

        /* List & Settings */
        .search-box { margin-bottom: 15px; position: relative; }
        .search-input { width: 100%; padding: 12px 15px 12px 40px; border-radius: 12px; border: 1px solid var(--border); background: white; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-sub); }
        .word-list { flex: 1; overflow-y: auto; padding-bottom: 80px; }
        .list-item { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border); }
        .item-content { flex: 1; overflow: hidden; }
        .item-meta { font-size: 0.75rem; color: #9ca3af; display: flex; gap: 10px; margin-top: 5px; }
        .item-actions { display: flex; gap: 10px; margin-left: 10px; }

        /* Navigation */
        .nav-bar { height: var(--nav-height); background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; padding-bottom: env(safe-area-inset-bottom); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sub); font-size: 0.7rem; gap: 4px; padding: 8px 0; width: 100%; }
        .nav-item.active { color: var(--primary); }
        .fab { position: fixed; bottom: calc(var(--nav-height) + 20px); right: 20px; width: 56px; height: 56px; background: var(--primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); z-index: 40; }

        /* UI Components */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 20px; padding: 25px; animation: popIn 0.3s; }
        @keyframes popIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .input-field { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; margin-bottom: 15px; display:block; }
        .toast { position: fixed; top: 15%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 10px 24px; border-radius: 30px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 200; font-weight: bold; white-space: nowrap; }
        .toast.show { opacity: 1; }
        .combo-text { position: absolute; top: 20%; left: 50%; transform: translateX(-50%) scale(0); font-size: 3rem; font-weight: 900; color: var(--warning); text-shadow: 0 2px 0 #fff, 0 5px 10px rgba(0,0,0,0.2); pointer-events: none; z-index: 50; transition: all 0.3s; opacity: 0; }
        .combo-text.show { transform: translateX(-50%) scale(1.2); opacity: 1; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="game-header">
        <div class="user-status">
            <div class="level-badge"><i class="fas fa-crown"></i> Lv.<span id="userLevel">1</span></div>
            <div class="streak-badge"><i class="fas fa-fire"></i> ËøûËÉú <span id="userStreak">0</span> Â§©</div>
        </div>
        <div class="xp-container"><div class="xp-bar" id="xpBar"></div></div>
        <div class="xp-text">
            <span>‰ªäÊó•: <span id="todayCount">0</span></span>
            <span>XP: <span id="currentXP">0</span> / <span id="nextLevelXP">100</span></span>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- 1. Home View -->
        <div id="view-home" class="view-section active">
            <div class="combo-text" id="comboText">COMBO!</div>
            <div id="reviewBanner" style="background:#fef3c7; color:#d97706; padding:10px; border-radius:10px; margin-bottom:10px; text-align:center; font-size:0.9rem; display:none;" onclick="startReview()">
                üîî Êúâ <span id="dueCount">0</span> ‰∏™Âà∞ÊúüÔºÅÁÇπÂáªÂ§ç‰π†
            </div>

            <div class="flashcard-container">
                <div class="flashcard">
                    <div class="card-face card-front" onclick="flipCard()">
                        <div class="card-scroll">
                            <div id="cardFront" class="card-text">...</div>
                            <div style="margin-top:20px; font-size:0.9rem; color:var(--text-sub); opacity:0.6;">(ÁÇπÂáªÁøªÈù¢)</div>
                        </div>
                        <i class="fas fa-volume-up" style="position:absolute; top:15px; right:15px; padding:10px; color:var(--text-sub);" onclick="speak(event, 'front')"></i>
                    </div>
                    <div class="card-face card-back" onclick="flipCard()">
                        <div class="card-scroll">
                            <div id="cardBack" class="card-text text-long" style="text-align:center;"></div>
                            <div style="margin-top:20px; padding:10px; background:rgba(99,102,241,0.1); border-radius:10px; font-size:0.9rem; color:var(--primary);" onclick="event.stopPropagation(); callAI()">
                                <i class="fas fa-magic"></i> AI ÂàÜÊûê
                            </div>
                            <div id="aiResult" style="font-size:0.9rem; margin-top:10px; text-align:left; width:100%;"></div>
                        </div>
                        <i class="fas fa-volume-up" style="position:absolute; top:15px; right:15px; padding:10px; color:var(--text-sub);" onclick="speak(event, 'back')"></i>
                    </div>
                </div>
            </div>

            <div class="controls-area">
                <div class="controls">
                    <button class="btn-action btn-fail" onclick="handleResult(0)"><i class="fas fa-times fa-lg"></i><span>ÂøòËÆ∞</span></button>
                    <button class="btn-action btn-hard" onclick="handleResult(3)"><i class="fas fa-question fa-lg"></i><span>Ê®°Á≥ä</span></button>
                    <button class="btn-action btn-pass" onclick="handleResult(5)"><i class="fas fa-check fa-lg"></i><span>ÁßíÊùÄ</span></button>
                </div>
            </div>
        </div>

        <!-- 2. List View -->
        <div id="view-list" class="view-section">
            <div class="search-box"><i class="fas fa-search search-icon"></i><input type="text" class="search-input" placeholder="ÊêúÁ¥¢..." oninput="filterList(this.value)"></div>
            <div class="word-list" id="wordListContainer"></div>
        </div>

        <!-- 3. Settings View -->
        <div id="view-settings" class="view-section">
            <h2 style="margin-bottom:20px;">ËÆæÁΩÆ & Êï∞ÊçÆ</h2>

            <!-- Local File Import -->
            <div style="background:white; border-radius:12px; padding:15px; border:1px solid var(--border); margin-bottom:15px;">
                <h3 style="font-size:1rem; margin-bottom:10px;">Êñá‰ª∂ÁÆ°ÁêÜ</h3>
                <div style="position:relative; margin-bottom:10px;">
                    <button class="input-field" style="background:var(--bg-color); text-align:center;"><i class="fas fa-file-upload"></i> ÂØºÂÖ•Êú¨Âú∞Êñá‰ª∂ (txt/json)</button>
                    <input type="file" onchange="importData(this)" class="input-field" accept=".txt,.json" style="position:absolute; top:0; left:0; opacity:0; width:100%; height:100%; cursor:pointer;">
                </div>
                <button class="input-field" onclick="exportData()" style="background:var(--bg-color); text-align:center;"><i class="fas fa-file-download"></i> ÂØºÂá∫Â§á‰ªΩ</button>
                <div style="font-size:0.8rem; color:var(--text-sub); margin-top:5px;">
                    * Ëã•ÈÉ®ÁΩ≤Âú®ÊúçÂä°Âô®ÔºåÂêØÂä®Êó∂‰ºöËá™Âä®ËØªÂèñÂêåÁ∫ß c.txt
                </div>
            </div>

            <!-- GitHub Sync -->
            <div style="background:white; border-radius:12px; padding:15px; margin-bottom:15px; border:1px solid var(--border);">
                <h3 style="font-size:1rem; margin-bottom:10px; display:flex; align-items:center;">
                    <i class="fab fa-github" style="margin-right:8px;"></i> GitHub ‰∫ëÂêåÊ≠•
                </h3>
                <input type="password" id="ghTokenInput" class="input-field" placeholder="GitHub Token" onchange="saveSettings()">
                <input type="text" id="gistIdInput" class="input-field" placeholder="Gist ID (Ëá™Âä®ÁîüÊàê)" onchange="saveSettings()">
                <div style="display:flex; gap:10px;">
                    <button class="input-field" onclick="syncToCloud()" style="background:var(--primary); color:white; border:none;">‰∏ä‰º†</button>
                    <button class="input-field" onclick="syncFromCloud()" style="background:var(--bg-color);">‰∏ãËΩΩ</button>
                </div>
            </div>

            <!-- Others -->
            <div style="background:white; border-radius:12px; padding:15px; border:1px solid var(--border);">
                <h3 style="font-size:1rem; margin-bottom:10px;">È´òÁ∫ß</h3>
                <input type="password" id="apiKeyInput" class="input-field" placeholder="AI API Key" onchange="saveSettings()">
                <button class="input-field" onclick="clearAllData()" style="color:var(--danger); border-color:var(--danger); text-align:center;">Ê∏ÖÁ©∫ÊâÄÊúâÊï∞ÊçÆ</button>
            </div>
        </div>
    </div>

    <div class="fab" onclick="openAddModal()"><i class="fas fa-plus"></i></div>
    <div class="nav-bar">
        <div class="nav-item active" onclick="switchView('home', this)"><i class="fas fa-layer-group"></i><span>Â≠¶‰π†</span></div>
        <div class="nav-item" onclick="switchView('list', this)"><i class="fas fa-list"></i><span>ÂçïËØçÊú¨</span></div>
        <div class="nav-item" onclick="switchView('settings', this)"><i class="fas fa-cog"></i><span>ËÆæÁΩÆ</span></div>
    </div>

    <!-- Modal & Toast -->
    <div class="modal" id="editModal"><div class="modal-content"><h3>Âç°Áâá</h3><input type="hidden" id="editIndex"><textarea id="inputFront" class="input-field" rows="3" placeholder="Ê≠£Èù¢"></textarea><textarea id="inputBack" class="input-field" rows="3" placeholder="ËÉåÈù¢"></textarea><div style="display:flex;justify-content:flex-end;gap:10px;"><button class="input-field" style="width:auto;" onclick="closeModal()">ÂèñÊ∂à</button><button class="input-field" style="width:auto;background:var(--primary);color:white;" onclick="saveCard()">‰øùÂ≠ò</button></div></div></div>
    <div class="toast" id="toast"></div>

    <script>
        /* === Data & State === */
        const App = {
            data: { words: [], user: { xp: 0, level: 1, streak: 0, lastLogin: null, history: {} } },
            state: { currentIdx: 0, queue: [], mode: 'practice', combo: 0,
                     apiKey: localStorage.getItem('mem_apikey') || '',
                     ghToken: localStorage.getItem('mem_gh_token') || '',
                     gistId: localStorage.getItem('mem_gist_id') || '' }
        };
        const XP_TABLE = [0,100,300,600,1000,1500,2200,3000,4000];

        window.onload = () => {
            loadData();
            if("Notification" in window && Notification.permission!=="granted") Notification.requestPermission();

            tryAutoLoadTxt(); // Ëá™Âä®ËØªÂèñ c.txt (‰ªÖÂú®ÊúçÂä°Âô®ÁéØÂ¢ÉÊúâÊïà)

            checkDailyStreak(); renderStats(); updateList();

            document.getElementById('ghTokenInput').value = App.state.ghToken;
            document.getElementById('gistIdInput').value = App.state.gistId;

            if(App.data.words.length===0) App.data.words.push({front:"Welcome",back:"ËØ∑ÂØºÂÖ•Êï∞ÊçÆÊàñÊ∑ªÂä†Âç°Áâá",nextReview:0,interval:0,repetitions:0,easeFactor:2.5});
            startPractice();
        };

        /* === File Parsing Logic === */
        function parseAndMergeTxt(text) {
            const lines = text.split(/\r?\n/);
            let addedCount = 0;
            lines.forEach(line => {
                if (!line.trim()) return;
                const parts = line.split('\t');
                const front = parts[0].trim();
                const back = parts[1] ? parts[1].trim() : '';
                const exists = App.data.words.some(w => w.front === front);
                if (!exists && front) {
                    App.data.words.push({front, back, nextReview:0, interval:0, repetitions:0, easeFactor:2.5, aiNote:''});
                    addedCount++;
                }
            });
            return addedCount;
        }

        async function tryAutoLoadTxt() {
            try {
                const res = await fetch('c.txt');
                if (res.ok) {
                    const text = await res.text();
                    const count = parseAndMergeTxt(text);
                    if (count > 0) { showToast(`Ëá™Âä®ÂêåÊ≠•: Êñ∞Â¢û ${count} ‰∏™ÂçïËØç`); saveData(); updateList(); }
                }
            } catch (e) { console.log("Local c.txt load skipped"); }
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                if (file.name.endsWith('.json')) {
                    try { App.data = JSON.parse(content); saveData(); location.reload(); }
                    catch(err) { showToast("JSONÊ†ºÂºèÈîôËØØ"); }
                } else {
                    const count = parseAndMergeTxt(content);
                    if (count > 0) {
                        showToast(`ÂØºÂÖ• ${count} Êù°Êï∞ÊçÆ`); saveData(); updateList();
                        if(App.state.currentIdx >= App.data.words.length) App.state.currentIdx=0;
                        renderCard();
                    } else { showToast("Êó†Êñ∞Êï∞ÊçÆÊàñÊ†ºÂºè‰∏çÂØπ"); }
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input
        }

        /* === Gist Sync === */
        async function syncToCloud() {
            if (!App.state.ghToken) return showToast("ËØ∑Â°´ÂÜôToken");
            showToast("Ê≠£Âú®‰∏ä‰º†...", 10000);
            try {
                const body = JSON.stringify({ "description": "MemoryPro Data", "public": false, "files": { "memorypro_data.json": { "content": JSON.stringify(App.data) } } });
                let url = 'https://api.github.com/gists'; let method = 'POST';
                if (App.state.gistId) { url += `/${App.state.gistId}`; method = 'PATCH'; }

                const res = await fetch(url, { method: method, headers: { "Authorization": `token ${App.state.ghToken}`, "Accept": "application/vnd.github.v3+json" }, body: body });
                if (!res.ok) {
                    const err = await res.json();
                    throw new Error(err.message || "Status " + res.status);
                }
                const json = await res.json();
                if (!App.state.gistId) { App.state.gistId = json.id; localStorage.setItem('mem_gist_id', json.id); document.getElementById('gistIdInput').value = json.id; }
                showToast("‚úÖ ‰∏ä‰º†ÊàêÂäü");
            } catch (e) { showToast("‚ùå Â§±Ë¥•: " + e.message); }
        }

        async function syncFromCloud() {
            if (!App.state.ghToken || !App.state.gistId) return showToast("ÈúÄTokenÂíåGistID");
            showToast("Ê≠£Âú®ÊãâÂèñ...", 5000);
            try {
                const res = await fetch(`https://api.github.com/gists/${App.state.gistId}`, { headers: { "Authorization": `token ${App.state.ghToken}` } });
                if (!res.ok) throw new Error("Status " + res.status);
                const json = await res.json();
                if (json.files && json.files["memorypro_data.json"]) {
                    if(confirm("Ë¶ÜÁõñÊú¨Âú∞Êï∞ÊçÆ?")) { App.data = JSON.parse(json.files["memorypro_data.json"].content); saveData(); location.reload(); }
                } else showToast("Êú™ÊâæÂà∞Êï∞ÊçÆÊñá‰ª∂");
            } catch (e) { showToast("‚ùå Â§±Ë¥•: " + e.message); }
        }

        /* === SM-2 Logic === */
        function handleResult(q) {
            if(App.data.words.length===0) return;
            const idx = App.state.mode==='review'?App.state.queue[0]:App.state.currentIdx;
            const item = App.data.words[idx];

            // SM-2 Algo
            if(!item.ef) item.ef=2.5; if(!item.int) item.int=0; if(!item.rep) item.rep=0;
            if(q===0){ item.rep=0; item.int=0; }
            else {
                item.ef = Math.max(1.3, item.ef + (0.1-(5-q)*(0.08+(5-q)*0.02)));
                if(item.rep===0) item.int=1; else if(item.rep===1) item.int=6; else item.int=Math.ceil(item.int*item.ef);
                item.rep++;
            }

            const now = Date.now();
            if(q===0) { item.nextReview = now + 300000; showToast("üò≠ Á®çÂêéÈáçÊù•"); addXP(5); App.state.combo=0; }
            else { item.nextReview = now + item.int*86400000; showToast(q===5?"üòé ÁßíÊùÄ":"ü§î ËÆ∞‰Ωè‰∫Ü"); addXP(q===5?20:10); triggerCombo(); }

            const t = new Date().toISOString().split('T')[0];
            App.data.user.history[t] = (App.data.user.history[t]||0)+1;
            saveData(); renderStats();

            if(App.state.mode==='review') {
                App.state.queue.shift();
                if(App.state.queue.length===0) { showToast("üéâ Â§ç‰π†ÂÆåÊàê"); startPractice(); } else renderCard();
            } else nextRandomCard();
            checkDue(); updateList();
        }

        function startReview() {
            const now=Date.now();
            const due=App.data.words.map((w,i)=>({...w,i})).filter(w=>w.nextReview<now && w.int>0).map(w=>w.i);
            const forgot=App.data.words.map((w,i)=>({...w,i})).filter(w=>w.int===0 && w.nextReview<now && w.nextReview>0).map(w=>w.i);
            const q=[...new Set([...due,...forgot])];
            if(q.length===0) return showToast("ÊöÇÊó†Âà∞Êúü");
            App.state.queue=q; App.state.mode='review'; renderCard();
        }

        /* === View & Utils === */
        function renderCard() {
            const idx = App.state.mode==='review'?App.state.queue[0]:App.state.currentIdx;
            const item = App.data.words[idx];
            if(!item) return;
            document.getElementById('cardFront').textContent=item.front;
            document.getElementById('cardBack').textContent=item.back||"";
            document.getElementById('aiResult').textContent=item.aiNote||"";
            document.querySelector('.flashcard').classList.remove('flipped');
            document.getElementById('cardFront').className = item.front.length>50?'card-text text-long':'card-text';
        }
        function renderStats() {
            const t = new Date().toISOString().split('T')[0];
            document.getElementById('userLevel').textContent=App.data.user.level;
            document.getElementById('userStreak').textContent=App.data.user.streak;
            document.getElementById('currentXP').textContent=App.data.user.xp;
            document.getElementById('todayCount').textContent=App.data.user.history[t]||0;
            const next=XP_TABLE[App.data.user.level]||App.data.user.level*1000;
            document.getElementById('nextLevelXP').textContent=next;
            document.getElementById('xpBar').style.width=((App.data.user.xp/next)*100)+'%';
            checkDue();
        }
        function checkDue() {
            const c=App.data.words.filter(w=>w.nextReview<Date.now() && w.nextReview>0).length;
            const b=document.getElementById('reviewBanner');
            if(c>0) { b.style.display='block'; document.getElementById('dueCount').textContent=c; } else b.style.display='none';
        }
        function updateList(f=''){
            const c=document.getElementById('wordListContainer'); c.innerHTML='';
            App.data.words.forEach((w,i)=>{
                if(f && !w.front.includes(f)) return;
                const d=document.createElement('div'); d.className='list-item';
                d.innerHTML=`<div class="item-content" onclick="jump(${i})"><div class="item-front">${w.front}</div><div style="color:#666;font-size:0.8rem">${w.back}</div></div><div class="item-actions"><i class="fas fa-trash" style="color:red" onclick="del(${i})"></i></div>`;
                c.appendChild(d);
            });
        }

        function addXP(n){ App.data.user.xp+=n; const next=XP_TABLE[App.data.user.level]||App.data.user.level*1000; if(App.data.user.xp>=next){App.data.user.level++;showToast("ÂçáÁ∫ßÂï¶!");confetti();} }
        function triggerCombo(){ App.state.combo++; if(App.state.combo>1){const e=document.getElementById('comboText');e.textContent=`COMBO x${App.state.combo}`;e.classList.add('show');setTimeout(()=>e.classList.remove('show'),800);} }
        function checkDailyStreak(){ const t=new Date().toISOString().split('T')[0]; if(App.data.user.lastLogin!==t){ const y=new Date(Date.now()-86400000).toISOString().split('T')[0]; App.data.user.streak=(App.data.user.lastLogin===y)?App.data.user.streak+1:1; App.data.user.lastLogin=t; saveData(); } }

        function saveSettings(){ App.state.apiKey=document.getElementById('apiKeyInput').value; App.state.ghToken=document.getElementById('ghTokenInput').value; App.state.gistId=document.getElementById('gistIdInput').value; localStorage.setItem('mem_apikey',App.state.apiKey); localStorage.setItem('mem_gh_token',App.state.ghToken); localStorage.setItem('mem_gist_id',App.state.gistId); }
        function saveData(){ localStorage.setItem('mem_pro_data', JSON.stringify(App.data)); }
        function loadData(){ const d=localStorage.getItem('mem_pro_data'); if(d)App.data=JSON.parse(d); if(!App.data.user.history)App.data.user.history={}; }
        function showToast(m,t=2000){ const el=document.getElementById('toast');el.textContent=m;el.classList.add('show');setTimeout(()=>el.classList.remove('show'),t); }

        function jump(i){App.state.currentIdx=i;App.state.mode='practice';switchView('home',document.querySelector('.nav-item'));renderCard();}
        function del(i){if(confirm('Âà†Èô§?')){App.data.words.splice(i,1);saveData();updateList();renderCard();}}
        function switchView(v,e){document.querySelectorAll('.view-section').forEach(x=>x.classList.remove('active'));document.getElementById('view-'+v).classList.add('active');if(e){document.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('active'));e.classList.add('active');}}
        function flipCard(){document.querySelector('.flashcard').classList.toggle('flipped');}
        function nextRandomCard(){App.state.currentIdx=Math.floor(Math.random()*App.data.words.length);renderCard();}
        function startPractice(){App.state.mode='practice';nextRandomCard();}
        function closeModal(){document.getElementById('editModal').style.display='none';}
        function openAddModal(){document.getElementById('editIndex').value='';document.getElementById('inputFront').value='';document.getElementById('inputBack').value='';document.getElementById('editModal').style.display='flex';}
        function saveCard(){const f=document.getElementById('inputFront').value,b=document.getElementById('inputBack').value;App.data.words.push({front:f,back:b,int:0,rep:0,ef:2.5,nextReview:0});saveData();closeModal();updateList();renderCard();}
        async function callAI(){if(!App.state.apiKey)return showToast("ËØ∑ÈÖçÁΩÆAPI Key");const item=App.data.words[App.state.mode==='review'?App.state.queue[0]:App.state.currentIdx];document.getElementById('aiResult').innerHTML='<i class="fas fa-spinner fa-spin"></i>';try{const r=await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions',{method:'POST',headers:{'Authorization':`Bearer ${App.state.apiKey}`,'Content-Type':'application/json'},body:JSON.stringify({model:"glm-4-flash",messages:[{role:"user",content:"ÂàÜÊûê:"+item.front}]})});const d=await r.json();item.aiNote=d.choices[0].message.content;document.getElementById('aiResult').textContent=item.aiNote;saveData();}catch(e){document.getElementById('aiResult').textContent="Err";}}
        function speak(e,s){e.stopPropagation();speechSynthesis.speak(new SpeechSynthesisUtterance(document.getElementById(s==='front'?'cardFront':'cardBack').textContent));}
        function exportData(){const a=document.createElement('a');a.href='data:json;charset=utf-8,'+encodeURIComponent(JSON.stringify(App.data));a.download='mempro_backup.json';a.click();}
        function clearAllData(){if(confirm('Ê∏ÖÁ©∫?')){localStorage.removeItem('mem_pro_data');location.reload();}}
    </script>
</body>
</html>